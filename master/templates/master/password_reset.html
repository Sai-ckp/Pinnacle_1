{% extends 'master/bare.html' %}

{% block title %}Reset Password{% endblock %}

{% block content %}
<h2>Reset Password</h2>

{% if error %}
<div class="alert" style="color: red;">{{ error }}</div>
{% endif %}

<form method="post" autocomplete="off" id="resetForm">
    {% csrf_token %}

    <label for="username">Username</label>
    <select name="username" class="input-field" required id="username" {% if username %}disabled{% endif %}>
        <option value="">Select User</option>
        {% for user in users %}
        <option value="{{ user.username }}" {% if username == user.username %}selected{% endif %}>
            {{ user.username }}
        </option>
        {% endfor %}
    </select>
    {% if username %}
    <input type="hidden" name="username" value="{{ username }}">
    {% endif %}

    <label for="passcode">Passcode</label>
    <input type="password" name="passcode" id="passcode" placeholder="Enter Passcode" class="input-field" minlength="4" maxlength="10" required autocomplete="off" autofocus>

    <div id="passcode-error" style="color: red; display: none; margin-top: 5px;">
        Passcode is wrong. Please contact admin.
    </div>

    <div id="password-section" style="{% if stage == 'set_new_password' %}display:block;{% else %}display:none;{% endif %}">
        <label for="new_password">New Password</label>
        <input type="password" name="new_password" id="new_password" placeholder="Enter New Password" class="input-field" minlength="8" maxlength="16" required autocomplete="new-password">
        <ul id="password-hints" style="color: red; list-style: none; padding-left: 0; margin-bottom: 10px;">
            <li id="pw-length" style="display:none;">At least 8 characters</li>
            <li id="pw-capital" style="display:none;">At least one capital letter</li>
            <li id="pw-special" style="display:none;">At least one special character (!@#$%^&amp;*(),.?":{}|&lt;&gt;)</li>
            <li id="pw-number" style="display:none;">At least one number</li>
        </ul>

        <label for="confirm_password">Confirm Password</label>
        <input type="password" name="confirm_password" id="confirm_password" placeholder="Confirm New Password" class="input-field" minlength="8" maxlength="16" required autocomplete="new-password">
        <div id="confirm-error" style="color: red; display: none; margin-bottom: 10px;">Passwords do not match</div>
    </div>

    <button type="submit" name="password_reset_submit" value="1">
        {% if stage == 'set_new_password' %}Set New Password{% else %}Reset Password{% endif %}
    </button>

    <a href="{% url 'login' %}{% if username %}?username={{ username }}{% endif %}">Back to Login</a>
</form>

{% if success_message %}
<script>
    alert("{{ success_message }}");
    window.location.href = "{% url 'login' %}?username={{ username }}";
</script>
{% endif %}

<script>
    // Realtime passcode checker
    document.addEventListener('DOMContentLoaded', function () {
        const usernameSelect = document.getElementById('username');
        const passcodeInput = document.getElementById('passcode');
        const errorDiv = document.getElementById('passcode-error');
        const passwordSection = document.getElementById('password-section');

        function checkPasscode() {
            // Use either usernameSelect.value or hidden username field value
            let username = usernameSelect.value;
            const hiddenInput = document.querySelector('input[type="hidden"][name="username"]');
            if (!username && hiddenInput) {
                username = hiddenInput.value;
            }
            const passcode = passcodeInput.value;

            if (!username || !passcode) {
                passwordSection.style.display = 'none';
                return;
            }

            fetch("{% url 'verify_passcode_view' %}", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ username: username, passcode: passcode })
            })
            .then(res => res.json())
            .then(data => {
                if (data.valid) {
                    errorDiv.style.display = 'none';
                    passwordSection.style.display = 'block';
                } else {
                    errorDiv.style.display = 'block';
                    passwordSection.style.display = 'none';
                }
            });
        }

        passcodeInput.addEventListener('input', function () {
            if (passcodeInput.value.length >= 4) {
                checkPasscode();
            } else {
                passwordSection.style.display = 'none';
            }
        });
    });

    // Password field validation
    {% if stage == 'set_new_password' %}
    const passwordInput = document.getElementById('new_password');
    const confirmInput = document.getElementById('confirm_password');
    const hints = {
        length: document.getElementById('pw-length'),
        capital: document.getElementById('pw-capital'),
        special: document.getElementById('pw-special'),
        number: document.getElementById('pw-number')
    };
    const confirmError = document.getElementById('confirm-error');

    function validatePassword() {
        const value = passwordInput.value;
        let valid = true;

        if (value.length < 8) {
            hints.length.style.display = 'block';
            valid = false;
        } else {
            hints.length.style.display = 'none';
        }

        if (!/[A-Z]/.test(value)) {
            hints.capital.style.display = 'block';
            valid = false;
        } else {
            hints.capital.style.display = 'none';
        }

        if (!/[!@#$%^&*(),.?":{}|<>]/.test(value)) {
            hints.special.style.display = 'block';
            valid = false;
        } else {
            hints.special.style.display = 'none';
        }

        if (!/[0-9]/.test(value)) {
            hints.number.style.display = 'block';
            valid = false;
        } else {
            hints.number.style.display = 'none';
        }

        return valid;
    }

    function validateConfirm() {
        if (confirmInput.value && confirmInput.value !== passwordInput.value) {
            confirmError.style.display = 'block';
            return false;
        } else {
            confirmError.style.display = 'none';
            return true;
        }
    }

    passwordInput.addEventListener('input', validatePassword);
    confirmInput.addEventListener('input', validateConfirm);

    document.getElementById('resetForm').addEventListener('submit', function (e) {
        let pwValid = validatePassword();
        let confirmValid = validateConfirm();
        if (!pwValid || !confirmValid) {
            e.preventDefault();
        }
    });
    {% endif %}
</script>
{% endblock %}