{% extends 'master/layout.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<h2 style="text-align: center; margin-top: 5px; color: #800000;">
    <i class="bi bi-speedometer2" style="font-size:1.3em; vertical-align:middle; margin-right:6px;"></i>
    Dashboard
</h2>

<!-- KPIs Section -->
<div class="kpi-container">
    <div class="kpi-card kpi-bg1">
        <h3>Total Students</h3>
        <p class="kpi-value">{{ total_students }}</p>
        <canvas id="sparkTotalStudents" class="kpi-spark"></canvas>
    </div>
    <div class="kpi-card kpi-bg2">
        <h3>Total PU Students</h3>
        <p class="kpi-value">{{ total_pu_students }}</p>
        <canvas id="sparkPUStudents" class="kpi-spark"></canvas>
    </div>
    <div class="kpi-card kpi-bg3">
        <h3>Total Degree Students</h3>
        <p class="kpi-value">{{ total_degree_students }}</p>
        <canvas id="sparkDegreeStudents" class="kpi-spark"></canvas>
    </div>
    <div class="kpi-card kpi-bg4">
        <h3>Total Enquiries</h3>
        <p class="kpi-value">{{ total_enquiries }}</p>
        <canvas id="sparkTotalEnquiries" class="kpi-spark"></canvas>
    </div>
    <div class="kpi-card kpi-bg5">
        <h3>Total PU Enquiries</h3>
        <p class="kpi-value">{{ total_pu_enquiries }}</p>
        <canvas id="sparkPUEnquiries" class="kpi-spark"></canvas>
    </div>
    <div class="kpi-card kpi-bg6">
        <h3>Total Degree Enquiries</h3>
        <p class="kpi-value">{{ total_degree_enquiries }}</p>
        <canvas id="sparkDegreeEnquiries" class="kpi-spark"></canvas>
    </div>
    <div class="kpi-card kpi-bg7">
        <h3>Total Messages Sent</h3>
        <p class="kpi-value">{{ total_messages_sent }}</p>
        <canvas id="sparkMessagesSent" class="kpi-spark"></canvas>
    </div>
    <div class="kpi-card kpi-bg8">
        <h3>Enquiries WhatsApp Sent</h3>
        <p class="kpi-value">{{ enquiries_whatsapp_sent }}</p>
        <canvas id="sparkWhatsappSent" class="kpi-spark"></canvas>
    </div>
    <div class="kpi-card kpi-bg9">
        <h3>Admission Messages Sent</h3>
        <p class="kpi-value">{{ admission_messages_sent }}</p>
        <canvas id="sparkAdmissionSent" class="kpi-spark"></canvas>
    </div>
    <div class="kpi-card kpi-bg10">
        <h3>Pending Messages</h3>
        <p class="kpi-value">{{ pending_messages }}</p>
        <canvas id="sparkPendingMessages" class="kpi-spark"></canvas>
    </div>
    <div class="kpi-card kpi-bg11">
        <h3>Total Employees</h3>
        <p class="kpi-value">{{ total_employees }}</p>
        <canvas id="sparkEmployees" class="kpi-spark"></canvas>
    </div>
    <div class="kpi-card kpi-bg12">
        <h3>Total Faculties</h3>
        <p class="kpi-value">{{ total_faculties }}</p>
        <canvas id="sparkFaculties" class="kpi-spark"></canvas>
    </div>
    <div class="kpi-card kpi-bg13">
        <h3>Faculty Attendance Rate</h3>
        <p class="kpi-value">{{ faculty_attendance_rate }}%</p>
        <canvas id="sparkFacultyAtt" class="kpi-spark"></canvas>
    </div>
    <div class="kpi-card kpi-bg14">
        <h3>Student Attendance Rate</h3>
        <p class="kpi-value">{{ student_attendance_rate }}%</p>
        <canvas id="sparkStudentAtt" class="kpi-spark"></canvas>
    </div>
    <div class="kpi-card kpi-bg15">
        <h3>Total Fee Collected</h3>
        <p class="kpi-value">₹{{ total_collected_fee|floatformat:0 }}</p>
        <canvas id="sparkFeeCollected" class="kpi-spark"></canvas>
    </div>
</div>

<!-- Charts Section -->
<div class="container">
    <div class="chart-container">
        <!-- Students Pie Chart -->
        <canvas id="studentsPieChart"></canvas>
    </div>
    <div class="chart-container">
        <!-- Enquiries Bar Chart -->
        <canvas id="enquiriesBarChart"></canvas>
    </div>
</div>

<div class="bottom-container">
    <div class="bottom-chart-container">
        <!-- Messages Line Chart (changed from bar to line) -->
        <canvas id="messagesLineChart"></canvas>
    </div>
    <div class="bottom-chart-container">
        <!-- Staff Bar Chart -->
        <canvas id="staffBarChart"></canvas>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Main Dashboard Charts
    new Chart(document.getElementById('studentsPieChart').getContext('2d'), {
        type: 'pie',
        data: {
            labels: ['Total Students', 'PU Students', 'Degree Students'],
            datasets: [{
                data: [{{ total_students }}, {{ total_pu_students }}, {{ total_degree_students }}],
                backgroundColor: ['#0d6efd', '#198754', '#fd7e14']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: 'Student Distribution' },
                legend: { position: 'bottom' }
            }
        }
    });

    new Chart(document.getElementById('enquiriesBarChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Total Enquiries', 'PU Enquiries', 'Degree Enquiries'],
            datasets: [{
                label: 'Enquiries',
                data: [{{ total_enquiries }}, {{ total_pu_enquiries }}, {{ total_degree_enquiries }}],
                backgroundColor: ['#6610f2', '#0dcaf0', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: 'Enquiries Overview' },
                legend: { display: false }
            },
            scales: { y: { beginAtZero: true } }
        }
    });

    // Messages Overview: LINE CHART (instead of bar)
    new Chart(document.getElementById('messagesLineChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: ['Total Sent', 'Enquiries WhatsApp', 'Admission Sent', 'Pending'],
            datasets: [{
                label: 'Messages',
                data: [{{ total_messages_sent }}, {{ enquiries_whatsapp_sent }}, {{ admission_messages_sent }}, {{ pending_messages }}],
                fill: false,
                borderColor: '#5f27cd',
                backgroundColor: '#feca57',
                tension: 0.35,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#5f27cd',
                pointRadius: 6,
                pointHoverRadius: 8,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: 'Messages Overview (Trend)' },
                legend: { display: false }
            },
            scales: { y: { beginAtZero: true } }
        }
    });

    new Chart(document.getElementById('staffBarChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Employees', 'Faculties'],
            datasets: [{
                label: 'Staff',
                data: [{{ total_employees }}, {{ total_faculties }}],
                backgroundColor: ['#8b0000', '#20c997']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: 'Staff Overview' },
                legend: { display: false }
            },
            scales: { y: { beginAtZero: true } }
        }
    });

    // --- KPI Sparklines & Mini Charts ---
    function sparkBar(id, value, color) {
        new Chart(document.getElementById(id).getContext('2d'), {
            type: 'bar',
            data: {
                labels: [''],
                datasets: [{
                    data: [value],
                    backgroundColor: [color],
                    borderRadius: 8,
                    barPercentage: 0.60,
                    categoryPercentage: 1
                }]
            },
            options: {
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                responsive: false,
                maintainAspectRatio: false,
                scales: {
                    x: { display: false, grid: { display: false } },
                    y: {
                        display: false,
                        grid: { display: false },
                        min: 0,
                        max: value * 1.25 + 5
                    }
                }
            }
        });
    }
    function sparkPie(id, value, other, color1, color2) {
        new Chart(document.getElementById(id).getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Current', 'Other'],
                datasets: [{
                    data: [value, other],
                    backgroundColor: [color1, color2],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '60%',
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                responsive: false,
                maintainAspectRatio: false
            }
        });
    }
    function sparkLine(id, values, color) {
        new Chart(document.getElementById(id).getContext('2d'), {
            type: 'line',
            data: {
                labels: values.map((v,i)=>i+1),
                datasets: [{
                    data: values,
                    borderColor: color,
                    borderWidth: 2.5,
                    pointRadius: 2.5,
                    pointBackgroundColor: color,
                    pointBorderColor: "#fff",
                    fill: false,
                    tension: 0.5
                }]
            },
            options: {
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                responsive: false,
                maintainAspectRatio: false,
                elements: { line: { borderJoinStyle: 'round' }},
                scales: {
                    x: { display: false, grid: { display: false } },
                    y: { display: false, grid: { display: false } }
                }
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function(){
        // Students
        sparkBar('sparkTotalStudents', {{ total_students }}, '#0d6efd');
        sparkPie('sparkPUStudents', {{ total_pu_students }}, Math.max(1, {{ total_students }}-{{ total_pu_students }}), '#198754', '#e8f5e9');
        sparkLine('sparkDegreeStudents', [{{ total_degree_students }}, {{ total_pu_students }}, {{ total_students }}], '#fd7e14');
        // Enquiries
        sparkPie('sparkTotalEnquiries', {{ total_enquiries }}, 100, '#6610f2', '#e3e3fa');
        sparkBar('sparkPUEnquiries', {{ total_pu_enquiries }}, '#0dcaf0');
        sparkLine('sparkDegreeEnquiries', [{{ total_degree_enquiries }}, {{ total_pu_enquiries }}, {{ total_enquiries }}], '#dc3545');
        // Messages
        sparkBar('sparkMessagesSent', {{ total_messages_sent }}, '#ffc107');
        sparkPie('sparkWhatsappSent', {{ enquiries_whatsapp_sent }}, Math.max(1, {{ total_messages_sent }}-{{ enquiries_whatsapp_sent }}), '#17a2b8', '#e0f7fa');
        sparkLine('sparkAdmissionSent', [{{ admission_messages_sent }}, {{ enquiries_whatsapp_sent }}, {{ total_messages_sent }}], '#6f42c1');
        sparkBar('sparkPendingMessages', {{ pending_messages }}, '#dc3545');
        // Staff/Attendance
        sparkPie('sparkEmployees', {{ total_employees }}, 100, '#8b0000', '#f2dede');
        sparkLine('sparkFaculties', [{{ total_faculties }}, {{ total_employees }}], '#20c997');
        sparkBar('sparkFacultyAtt', {{ faculty_attendance_rate }}, '#198754');
        sparkPie('sparkStudentAtt', {{ student_attendance_rate }}, 100-{{ student_attendance_rate }}, '#0d6efd', '#e3eaff');
        sparkLine('sparkFeeCollected', [{{ total_collected_fee|floatformat:0 }}, 100000], '#f39c12');
    });
</script>

<style>
    body {
        background: #fff !important;
    }

    .kpi-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        gap: 14px 18px;
        margin: 24px 20px 16px 20px;
        overflow-x: auto;
    }

    .kpi-card {
        flex: 1 1 170px;
        min-width: 175px;
        max-width: 210px;
        text-align: center;
        padding: 14px 8px 2px 8px;
        border-radius: 13px;
        background-color: #fff;
        box-shadow: 0 2px 14px rgba(0,0,0,0.06);
        font-size: 13px;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        transition: box-shadow 0.2s, transform 0.16s;
        overflow: hidden;
    }

        .kpi-card:hover {
            box-shadow: 0 4px 18px rgba(139,0,0,0.13);
            transform: translateY(-2px) scale(1.03);
            z-index: 1;
        }

        .kpi-card h3 {
            margin-bottom: 1px;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: .02em;
            color: #800000;
        }

    .kpi-value {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 0;
        color: #800;
    }

    .kpi-spark {
        width: 90px !important;
        height: 36px !important;
        margin: 8px auto 2px auto;
        display: block;
        background: transparent;
        border-radius: 7px;
        border: 1.5px solid #eee;
        box-shadow: 0 1px 6px rgba(0,0,0,0.04);
    }
    /* Soft gradient overlays for visual distinction, while keeping white background */
    .kpi-bg1::before {
        background: linear-gradient(90deg,#e3eafe33 0,#fff0 100%);
    }

    .kpi-bg2::before {
        background: linear-gradient(90deg,#e8f5e933 0,#fff0 100%);
    }

    .kpi-bg3::before {
        background: linear-gradient(90deg,#fff3e033 0,#fff0 100%);
    }

    .kpi-bg4::before {
        background: linear-gradient(90deg,#ede7f633 0,#fff0 100%);
    }

    .kpi-bg5::before {
        background: linear-gradient(90deg,#e0f7fa33 0,#fff0 100%);
    }

    .kpi-bg6::before {
        background: linear-gradient(90deg,#ffebee33 0,#fff0 100%);
    }

    .kpi-bg7::before {
        background: linear-gradient(90deg,#fffde733 0,#fff0 100%);
    }

    .kpi-bg8::before {
        background: linear-gradient(90deg,#e0ffe933 0,#fff0 100%);
    }

    .kpi-bg9::before {
        background: linear-gradient(90deg,#ede7f633 0,#fff0 100%);
    }

    .kpi-bg10::before {
        background: linear-gradient(90deg,#ffe0b233 0,#fff0 100%);
    }

    .kpi-bg11::before {
        background: linear-gradient(90deg,#f8bbd033 0,#fff0 100%);
    }

    .kpi-bg12::before {
        background: linear-gradient(90deg,#b2ebf233 0,#fff0 100%);
    }

    .kpi-bg13::before {
        background: linear-gradient(90deg,#e8f5e933 0,#fff0 100%);
    }

    .kpi-bg14::before {
        background: linear-gradient(90deg,#e3eafe33 0,#fff0 100%);
    }

    .kpi-bg15::before {
        background: linear-gradient(90deg,#fffde733 0,#fff0 100%);
    }

    .kpi-card[class*='kpi-bg']::before {
        content: "";
        position: absolute;
        inset: 0;
        z-index: 0;
        border-radius: 13px;
        pointer-events: none;
        opacity: 0.95;
    }

    .container {
        display: flex;
        justify-content: space-between;
        margin: 30px 24px;
        background: #fff;
    }

    .chart-container {
        width: 48%;
        height: 32vh;
        min-width: 250px;
    }

    canvas {
        width: 100% !important;
        height: 100% !important;
    }

    .bottom-container {
        display: flex;
        justify-content: space-between;
        margin: 20px 50px;
        gap: 10px;
        background: #fff;
    }

    .bottom-chart-container {
        width: 48%;
        height: 32vh;
        min-width: 250px;
    }

    @media (max-width: 991.98px) {
        .container, .bottom-container {
            flex-direction: column;
            margin: 10px;
        }

        .chart-container, .bottom-chart-container {
            width: 100%;
            min-width: 0;
            margin-bottom: 18px;
        }

        .kpi-container {
            flex-direction: column;
            align-items: stretch;
        }
    }
</style>
{% endblock %}