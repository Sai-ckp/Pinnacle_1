{% extends 'layout.html' %}
{% block title %}{% if form.instance.pk %}
  Edit Fee Declaration
{% else %}
  Add Fee Declaration
{% endif %}{% endblock %}
{% block content %}
<style>
    .form-section {
        background: #fff;
        padding: 32px 40px;
        border-radius: 12px;
        margin: 40px auto;
        width: 960px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    }

        .form-section h4 {
            text-align: center;
            color: #800;
            font-size: 18px;
            margin-bottom: 10px;
        }

    .firsts {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        justify-content: space-between;
        margin-bottom: 24px;
    }

    select, input[type="date"], input[type="number"] {
        padding: 6px 10px;
        font-size: 13px;
        min-width: 160px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .btn-maroon {
        background-color: #800000;
        color: white;
        font-weight: 500;
        font-size: 14px;
        padding: 8px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.2s ease;
    }

        .btn-maroon:hover {
            background-color: #a00000;
        }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 3px;
        text-align: center;
        font-size: 12px;
    }

    th {
        background: #800;
        color: #fff;
    }

    .btn-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 40px;
    }

    .icon-btn {
        border: 1px solid #dee2e6;
        background-color: #fff;
        padding: 2px 4px;
        margin: 2px;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
        text-decoration: none;
        display: inline-block;
        font-size: 9px;
    }

        .icon-btn i {
            font-size: 11px;
            color: #800000;
        }

        .icon-btn.text-danger i {
            color: #b30000;
        }

    #add-row {
        margin-top: 24px;
        /*        margin-left: auto;
    */ display: block;
        padding: 5px 5px;
        font-size: 12px;
    }

    .fee-row button.remove-row {
        /*        background-color: #d9534f;
    */ color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
    }

        .fee-row button.remove-row:hover {
            /*        background-color: #c9302c;
    */
        }

    ul.errorlist {
        color: red;
        margin: 0 0 15px 0;
        list-style-type: none;
    }

    .content {
        margin-left: 200px;
        padding: 0px 26px 40px;
        min-height: 100vh;
    }
</style>

<div class="form-section">
    <h4>
        {% if form.instance.pk %}
        Edit Fee Declaration
        {% else %}
        Add Fee Declaration
        {% endif %}
    </h4>
    <form method="post">
        {% if form.non_field_errors %}
        <ul class="errorlist">
            {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        {% csrf_token %}

        <div class="firsts">
            <!-- Program Type -->
            {% if form.instance.pk %}
            <select name="course_type" disabled>
                <option value="">Select Program Type</option>
                {% for ct in course_types %}
                <option value="{{ ct.id }}" {% if ct.id == selected_course_type_id %}selected{% endif %}>{{ ct.name }}</option>
                {% endfor %}
            </select>
            <input type="hidden" name="course_type" value="{{ selected_course_type_id }}">
            {% else %}
            <select name="course_type" onchange="this.form.submit()">
                <option value="">Select Program Type</option>
                {% for ct in course_types %}
                <option value="{{ ct.id }}" {% if ct.id == selected_course_type_id %}selected{% endif %}>{{ ct.name }}</option>
                {% endfor %}
            </select>
            {% endif %}


            {% if form.instance.pk %}
            <select name="academic_year" disabled>
                <option value="">Select Academic Year</option>
                {% for ay in academic_years %}
                <option value="{{ ay.id }}" {% if ay.id == selected_academic_year_id %}selected{% endif %}>{{ ay.year }}</option>
                {% endfor %}
            </select>
            <input type="hidden" name="academic_year" value="{{ selected_academic_year_id }}">
            {% else %}
            <select name="academic_year" onchange="this.form.submit()" {% if not selected_course_type_id %}disabled{% endif %}>
                <option value="">Select Academic Year</option>
                {% for ay in academic_years %}
                <option value="{{ ay.id }}" {% if ay.id == selected_academic_year_id %}selected{% endif %}>{{ ay.year }}</option>
                {% endfor %}
            </select>
            {% endif %}


            {% if form.instance.pk %}
            <select name="course" disabled>
                <option value="">Select Combination</option>
                {% for c in courses %}
                <option value="{{ c.id }}" {% if c.id == selected_course %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
            <input type="hidden" name="course" value="{{ selected_course }}">
            {% else %}
            <select name="course" id="course-select" {% if not selected_course_type_id %}disabled{% endif %}>
                <option value="">Select Combination</option>
                {% for c in courses %}
                <option value="{{ c.id }}" {% if c.id == selected_course %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
            {% endif %}


            {% if form.instance.pk %}
            <select name="semester_or_year" disabled>
                <option value="">Select Sem/Year</option>
                {% for sem in semester_or_years %}
                <option value="{{ sem.number }}" {% if sem.number == selected_sem_or_year %}selected{% endif %}>{{ sem.name }}</option>
                {% endfor %}
            </select>
            <input type="hidden" name="semester_or_year" value="{{ selected_sem_or_year }}">
            {% else %}
            <select name="semester_or_year" id="semester-select">
                <option value="">Select Sem/Year</option>
                {% for sem in semester_or_years %}
                <option value="{{ sem.number }}" {% if sem.number == selected_sem_or_year %}selected{% endif %}>{{ sem.name }}</option>
                {% endfor %}
            </select>
            {% endif %}

        </div>
        <!-- Add Fee Button -->
        <!-- Fee Table (Initially Hidden for Add View) -->
        <div class="fee-table-container" style="{% if not form.instance.pk %}display:none;{% endif %}; margin-top: 20px;">
            <h4>Fee Details</h4>
            {{ formset.management_form }}
        <table>
            <thead>
                <tr><th>Fee Type</th><th>Amount</th><th>Due Date</th><th>Delete</th></tr>
            </thead>
            <tbody id="fee-body">
                {% if form.instance.pk %}
                {# This is edit view - show existing rows #}
                {% for form in formset.forms %}
                <tr class="fee-row">
                    {{ form.id }}
                    <td>{{ form.fee_type }}</td>
                    <td>{{ form.amount }}</td>
                    <td>{{ form.due_date }}</td>
                    <td>
                        <button type="button" class="icon-btn text-danger remove-row" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% endif %}

                <tr class="fee-row" id="fee-row-template" style="display: none;">
                    {{ formset.empty_form.id }}
                    <td class="fee-type-cell"></td>
                    <td class="amount-cell"></td>
                    <td class="due-date-cell"></td>
                    <td class="delete-cell"></td>
                </tr>
            </tbody>

        </table>
        </div>


        <!-- Add Fee Button -->
        <button type="button" id="add-row" class="btn-maroon">+ Add Fee</button>


        <!-- Bottom Buttons -->
        <div class="btn-container">
            <a href="{% url 'fee_declaration_list' %}" class="btn-maroon">Back</a>
            {% if not is_view %}
            <button type="submit" class="btn-maroon">
                {% if form.instance.pk %}Update{% else %}Save{% endif %}
            </button>
            {% endif %}
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function updateAvailableFeeTypes() {
        const selectedTypes = new Set();
        $('.fee-row select[name$="fee_type"]').each(function () {
            selectedTypes.add($(this).val());
        });

        $('.fee-row select[name$="fee_type"]').each(function () {
            const current = $(this).val();
            $(this).find('option').each(function () {
                if ($(this).val() && $(this).val() !== current && selectedTypes.has($(this).val())) {
                    $(this).hide();
                } else {
                    $(this).show();
                }
            });
        });
    }

    const addBtn = document.getElementById("add-row"),
          tbody = document.getElementById("fee-body"),
          total = document.getElementById("id_fee_details-TOTAL_FORMS");

    addBtn.onclick = () => {
        let count = parseInt(total.value);
        const template = document.getElementById("fee-row-template");
        const newRow = template.cloneNode(true);
        newRow.style.display = "";
        newRow.id = "";

        // Create temp container to parse escaped form HTML
        const emptyFormHTML = `{{ formset.empty_form.as_table|escapejs }}`.replace(/__prefix__/g, count);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = emptyFormHTML;

        const feeType = tempDiv.querySelector('select[name$="fee_type"]');
        const amount = tempDiv.querySelector('input[name$="amount"]');
        const dueDate = tempDiv.querySelector('input[name$="due_date"]');

        $(newRow).find('.fee-type-cell').append(feeType);
        $(newRow).find('.amount-cell').append(amount);
        $(newRow).find('.due-date-cell').append(dueDate);

        $(newRow).find('.delete-cell').html(`
        <button type="button" class="icon-btn text-danger remove-row" title="Delete">
            <i class="fas fa-trash-alt"></i>
        </button>
    `);

        tbody.appendChild(newRow);
        total.value = count + 1;

        updateAvailableFeeTypes();
    };



    document.addEventListener("click", e => {
        const removeBtn = e.target.closest(".remove-row");
        if (removeBtn) {
            removeBtn.closest("tr").remove();
            total.value = document.querySelectorAll(".fee-row").length;
            updateAvailableFeeTypes();
        }
    });


    if (removeBtn && confirm("Are you sure you want to delete this row?")) {
        removeBtn.closest("tr").remove();
        total.value = document.querySelectorAll(".fee-row").length;
        updateAvailableFeeTypes();
    }

    $(document).ready(function () {
        updateAvailableFeeTypes();

        $('#course-select').change(function () {
            const courseId = $(this).val();
            if (!courseId) {
                $('#semester-select').html('<option value="">Select Sem/Year</option>');
                return;
            }

            $.ajax({
                type: "POST",
                url: "{% url 'get_semesters_by_course' %}",
                data: {
                    'course_id': courseId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    const semesterSelect = $('#semester-select');
                    semesterSelect.empty();
                    semesterSelect.append('<option value="">Select Sem/Year</option>');
                    $.each(response.semesters, function (i, sem) {
                        semesterSelect.append(`<option value="${sem.number}">${sem.name}</option>`);
                    });
                },
                error: function () {
                    alert('Error fetching semester data');
                }
            });
        });

        $('form').on('change', 'select[name$="fee_type"]', function () {
            updateAvailableFeeTypes();
        });
    });
</script>



<script>
    $(document).ready(function () {
        updateAvailableFeeTypes();

        // Trigger semester loading if course is already selected (e.g., after form validation errors)
        const preSelectedCourseId = $('#course-select').val();
        const semesterSelect = $('#semester-select');

        if (preSelectedCourseId && semesterSelect.children('option').length <= 1) {
            // Call AJAX manually to populate semesters
            $.ajax({
                type: "POST",
                url: "{% url 'get_semesters_by_course' %}",
                data: {
                    'course_id': preSelectedCourseId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    semesterSelect.empty();
                    semesterSelect.append('<option value="">Select Sem/Year</option>');
                    $.each(response.semesters, function (i, sem) {
                        semesterSelect.append(`<option value="${sem.number}">${sem.name}</option>`);
                    });

                    // Re-select previously selected value if any
                    const selectedVal = "{{ selected_sem_or_year|default:'' }}";
                    if (selectedVal) {
                        semesterSelect.val(selectedVal);
                    }
                },
                error: function () {
                    alert('Error fetching semester data');
                }
            });
        }

        $('#course-select').change(function () {
            const courseId = $(this).val();
            if (!courseId) {
                semesterSelect.html('<option value="">Select Sem/Year</option>');
                return;
            }

            $.ajax({
                type: "POST",
                url: "{% url 'get_semesters_by_course' %}",
                data: {
                    'course_id': courseId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    semesterSelect.empty();
                    semesterSelect.append('<option value="">Select Sem/Year</option>');
                    $.each(response.semesters, function (i, sem) {
                        semesterSelect.append(`<option value="${sem.number}">${sem.name}</option>`);
                    });
                },
                error: function () {
                    alert('Error fetching semester data');
                }
            });
        });

        $('form').on('change', 'select[name$="fee_type"]', function () {
            updateAvailableFeeTypes();
        });
    });

</script>

<style>
    .field-error {
        border: 1px solid red;
        background-color: #ffe6e6;
    }

    .error-message {
        color: red;
        font-size: 11px;
        margin-top: 4px;
    }
</style>

<script>
    function showError(element, message) {
        const error = document.createElement('div');
        error.className = 'error-message';
        error.textContent = message;

        element.classList.add('field-error');

        if (element.parentNode && !element.parentNode.querySelector('.error-message')) {
            element.parentNode.appendChild(error);
        }

        // Remove error on change or input
        element.addEventListener('input', removeError, { once: true });
        element.addEventListener('change', removeError, { once: true });

        function removeError() {
            element.classList.remove('field-error');
            if (error.parentNode) {
                error.parentNode.removeChild(error);
            }
        }
    }

    document.querySelector('form').addEventListener('submit', function (e) {
        let isValid = true;

        // Clear existing errors
        document.querySelectorAll('.error-message').forEach(el => el.remove());
        document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));

        // Top-level required fields
        const courseType = document.querySelector('select[name="course_type"]');
        const academicYear = document.querySelector('select[name="academic_year"]');
        const course = document.querySelector('select[name="course"]');
        const semester = document.querySelector('select[name="semester_or_year"]');

        if (courseType && !courseType.disabled && !courseType.value) {
            isValid = false;
            showError(courseType, /*"Program Type is required."*/);
        }

        if (academicYear && !academicYear.disabled && !academicYear.value) {
            isValid = false;
            showError(academicYear, "Academic Year is required.");
        }

        if (course && !course.disabled && !course.value) {
            isValid = false;
            showError(course, "Combination is required.");
        }

        if (semester && !semester.disabled && !semester.value) {
            isValid = false;
            showError(semester, "Sem/Year is required.");
        }

        // Fee detail rows
        // Fee detail rows
        document.querySelectorAll('.fee-row').forEach((row) => {
            if (row.style.display === 'none') return;

            const feeType = row.querySelector('select[name$="fee_type"]');
            const amount = row.querySelector('input[name$="amount"]');
            const dueDate = row.querySelector('input[name$="due_date"]');

            if (feeType && !feeType.value) {
                isValid = false;
                showError(feeType, "Fee Type is required.");
            }

            if (amount) {
                const value = parseFloat(amount.value);
                if (isNaN(value) || value <= 0) {
                    isValid = false;
                    showError(amount, "Amount must be greater than 0.");
                }
            }

            if (dueDate && dueDate.value.trim() === '') {
                isValid = false;
                showError(dueDate, "Due Date is required.");
            }
        });


        // Scroll to the first error and prevent submission
        if (!isValid) {
            e.preventDefault();
            const firstError = document.querySelector('.field-error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }
    });
</script>











<script>
    document.addEventListener("DOMContentLoaded", function () {
        // This script ensures child table is shown only on clicking +Add Fee in Add View
        const isEdit = {{ form.instance.pk|yesno:"true,false" }};
        const feeTableContainer = document.querySelector(".fee-table-container");
        const addRowBtn = document.getElementById("add-row");

        if (!isEdit && feeTableContainer) {
            feeTableContainer.style.display = "none";
        }

        if (!isEdit && addRowBtn) {
            addRowBtn.addEventListener("click", function () {
                feeTableContainer.style.display = "block";
            });
        }
    });
</script>


<script>
    $(document).ready(function () {
        {% if not form.instance.pk %}
        $('.fee-table-container').hide();
        {% endif %}

        $('#add-row').on('click', function () {
            $('.fee-table-container').show();
        });
    });
</script>


{% endblock %}
