{% extends 'master/bare.html' %}

{% block title %}Reset Password{% endblock %}

{% block content %}
<style>
    #resetForm {
        max-width: 400px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .form-group {
        width: 100%;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
    }

    label {
        margin-bottom: 5px;
        font-weight: bold;
        text-align: center;
    }

    .input-field {
        width: 100%;
        padding: 8px 10px;
        font-size: 14px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    input.input-field, select.input-field {
        display: block;
        margin: 0;
    }


    button[type="submit"] {
        padding: 10px 20px;
        font-size: 1rem;
        cursor: pointer;
        margin-top: 10px;
        align-self: center;
    }

    a {
        margin-top: 15px;
        text-align: center;
        display: block;
        text-decoration: none;
        color: #007BFF;
    }

        a:hover {
            text-decoration: underline;
        }

    #password-hints {
        list-style: none;
        padding-left: 0;
        color: red;
        text-align: left;
        margin-top: -10px;
        margin-bottom: 10px;
    }

    #passcode-error,
    #confirm-error {
        color: red;
        text-align: center;
        margin-top: 5px;
    }
</style>

<h2 style="text-align:center;">Reset Password</h2>

{% if error %}
<div class="alert" style="color: red; text-align:center;">{{ error }}</div>
{% endif %}

<form method="post" autocomplete="off" id="resetForm">
    {% csrf_token %}

    <div class="form-group">
        <label for="username">Username</label>
        <select name="username" class="input-field" required id="username" {% if username %}disabled{% endif %}>
            <option value="">Select User</option>
            {% for user in users %}
            <option value="{{ user.username }}" {% if username == user.username %}selected{% endif %}>
                {{ user.username }}
            </option>
            {% endfor %}
        </select>
        {% if username %}
        <input type="hidden" name="username" value="{{ username }}">
        {% endif %}
    </div>

    <div class="form-group">
        <label for="passcode">Passcode</label>
        <input type="password" name="passcode" id="passcode" placeholder="Enter Passcode"
               class="input-field" minlength="4" maxlength="10" required autocomplete="off" autofocus>
        <div id="passcode-error" style="display: none;">
            Passcode is wrong. Please contact admin.
        </div>
    </div>

    <div class="form-group" id="password-section" style="{% if stage == 'set_new_password' %}display:block;{% else %}display:none;{% endif %}">
        <label for="new_password">New Password</label>
        <input type="password" name="new_password" id="new_password" placeholder="Enter New Password"
               class="input-field" minlength="8" maxlength="16" required autocomplete="new-password">

        <ul id="password-hints">
            <li id="pw-length" style="display:none;">At least 8 characters</li>
            <li id="pw-capital" style="display:none;">At least one capital letter</li>
            <li id="pw-special" style="display:none;">At least one special character (!@#$%^&*(),.?":{}|&lt;&gt;)</li>
            <li id="pw-number" style="display:none;">At least one number</li>
        </ul>

        <label for="confirm_password">Confirm Password</label>
        <input type="password" name="confirm_password" id="confirm_password" placeholder="Confirm New Password"
               class="input-field" minlength="8" maxlength="16" required autocomplete="new-password">

        <div id="confirm-error" style="display: none;">Passwords do not match</div>
    </div>


    <button type="submit" name="password_reset_submit" value="1">
        {% if stage == 'set_new_password' %}Set New Password{% else %}Reset Password{% endif %}
    </button>

    <a href="{% url 'login' %}{% if username %}?username={{ username }}{% endif %}">Back to Login</a>
</form>

{% if success_message %}
<script>
    alert("{{ success_message }}");
    window.location.href = "{% url 'login' %}?username={{ username }}";
</script>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const usernameSelect = document.getElementById('username');
        const passcodeInput = document.getElementById('passcode');
        const errorDiv = document.getElementById('passcode-error');
        const passwordSection = document.getElementById('password-section');

        function checkPasscode() {
            let username = usernameSelect.value;
            const hiddenInput = document.querySelector('input[type="hidden"][name="username"]');
            if (!username && hiddenInput) {
                username = hiddenInput.value;
            }

            const passcode = passcodeInput.value;
            if (!username || !passcode) {
                passwordSection.style.display = 'none';
                return;
            }

            fetch("{% url 'verify_passcode_view' %}", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ username: username, passcode: passcode })
            })
            .then(res => res.json())
            .then(data => {
                if (data.valid) {
                    errorDiv.style.display = 'none';
                    passwordSection.style.display = 'block';
                } else {
                    errorDiv.style.display = 'block';
                    passwordSection.style.display = 'none';
                }
            });
        }

        passcodeInput.addEventListener('input', function () {
            if (passcodeInput.value.length >= 4) {
                checkPasscode();
            } else {
                passwordSection.style.display = 'none';
            }
        });

        {% if stage == 'set_new_password' %}
        const passwordInput = document.getElementById('new_password');
        const confirmInput = document.getElementById('confirm_password');
        const hints = {
            length: document.getElementById('pw-length'),
            capital: document.getElementById('pw-capital'),
            special: document.getElementById('pw-special'),
            number: document.getElementById('pw-number')
        };
        const confirmError = document.getElementById('confirm-error');

        function validatePassword() {
            const value = passwordInput.value;
            let valid = true;

            hints.length.style.display = value.length < 8 ? 'block' : 'none';
            hints.capital.style.display = /[A-Z]/.test(value) ? 'none' : 'block';
            hints.special.style.display = /[!@#$%^&*(),.?":{}|<>]/.test(value) ? 'none' : 'block';
            hints.number.style.display = /[0-9]/.test(value) ? 'none' : 'block';

            return hints.length.style.display === 'none' &&
                   hints.capital.style.display === 'none' &&
                   hints.special.style.display === 'none' &&
                   hints.number.style.display === 'none';
        }

        function validateConfirm() {
            const match = confirmInput.value === passwordInput.value;
            confirmError.style.display = match ? 'none' : 'block';
            return match;
        }

        passwordInput.addEventListener('input', validatePassword);
        confirmInput.addEventListener('input', validateConfirm);

        document.getElementById('resetForm').addEventListener('submit', function (e) {
            if (!validatePassword() || !validateConfirm()) {
                e.preventDefault();
            }
        });
        {% endif %}
    });
</script>
{% endblock %}
