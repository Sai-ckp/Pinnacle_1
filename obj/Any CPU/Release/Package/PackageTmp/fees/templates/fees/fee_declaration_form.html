{% extends 'layout.html' %}
{% block title %}Add Fee Declaration{% endblock %}
{% block content %}
<style>
    .form-section {
        background: #fff;
        padding: 32px 40px;
        border-radius: 12px;
        margin: 40px auto;
        width: 960px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    }

    .form-section h4 {
        text-align: center;
        color: #800;
        font-size: 18px;
        margin-bottom: 10px;
    }

    .firsts {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        justify-content: space-between;
        margin-bottom: 24px;
    }

    select, input[type="date"], input[type="number"] {
        padding: 6px 10px;
        font-size: 13px;
        min-width: 160px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .btn-maroon {
        background-color: #800000;
        color: white;
        font-weight: 500;
        font-size: 14px;
        padding: 8px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.2s ease;
    }

    .btn-maroon:hover {
        background-color: #a00000;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    th, td {
            border: 1px solid #ddd;
    padding: 3px;
    text-align: center;
    font-size: 12px;

    }

    th {
        background: #800;
        color: #fff;
    }

    .btn-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 40px;
    }

    #add-row {
        margin-top: 24px;
        margin-left: auto;
        display: block;
    }

    .fee-row button.remove-row {
        background-color: #d9534f;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
    }

    .fee-row button.remove-row:hover {
        background-color: #c9302c;
    }

    ul.errorlist {
        color: red;
        margin: 0 0 15px 0;
        list-style-type: none;
    }

    .content {
        margin-left: 200px;
        padding: 31px 26px 40px;
        min-height: 100vh;
    }
</style>

<div class="form-section">
    <h4>Add Fee Declaration</h4>
    <form method="post">
        {% if form.non_field_errors %}
            <ul class="errorlist">
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        {% csrf_token %}

        <div class="firsts">
            <select name="course_type" onchange="this.form.submit()">
                <option value="">Select Program Type</option>
                {% for ct in course_types %}
                    <option value="{{ ct.id }}" {% if ct.id == selected_course_type_id %}selected{% endif %}>
                        {{ ct.name }}
                    </option>
                {% endfor %}
            </select>

            <select name="academic_year" onchange="this.form.submit()" {% if not selected_course_type_id %}disabled{% endif %}>
                <option value="">Select Academic Year</option>
                {% for ay in academic_years %}
                    <option value="{{ ay.id }}" {% if ay.id == selected_academic_year_id %}selected{% endif %}>
                        {{ ay.year }}
                    </option>
                {% endfor %}
            </select>

            <select name="course" id="course-select" {% if not selected_course_type_id %}disabled{% endif %}>
                <option value="">Select Combination</option>
                {% for c in courses %}
                    <option value="{{ c.id }}" {% if c.id == selected_course %}selected{% endif %}>
                        {{ c.name }}
                    </option>
                {% endfor %}
            </select>

            <select name="semester_or_year" id="semester-select">
                <option value="">Select Sem/Year</option>
                {% for sem in semester_or_years %}
                    <option value="{{ sem.number }}" {% if sem.number == selected_sem_or_year %}selected{% endif %}>
                        {{ sem.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <h4 style="margin-top: 20px;">Fee Details</h4>
        {{ formset.management_form }}
        <table>
            <thead>
                <tr><th>Fee Type</th><th>Amount</th><th>Due Date</th><th>Delete</th></tr>
            </thead>
            <tbody id="fee-body">
                {% for f in formset %}
                <tr class="fee-row">
                    {{ f.id }}
                    <td>{{ f.fee_type }}</td>
                    <td>{{ f.amount }}</td>
                    <td>{{ f.due_date }}</td>
                    <td><button type="button" class="remove-row">X</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Add Fee Button -->
        <button type="button" id="add-row" class="btn-maroon">+ Add Fee</button>

        <!-- Bottom Buttons -->
        <div class="btn-container">
            <a href="{% url 'fee_declaration_list' %}" class="btn-maroon">Back</a>
            {% if not is_view %}
            <button type="submit" class="btn-maroon">
                {% if form.instance.pk %}Update{% else %}Save{% endif %}
            </button>
            {% endif %}
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function updateAvailableFeeTypes() {
        const selectedTypes = new Set();
        $('.fee-row select[name$="fee_type"]').each(function () {
            selectedTypes.add($(this).val());
        });

        $('.fee-row select[name$="fee_type"]').each(function () {
            const current = $(this).val();
            $(this).find('option').each(function () {
                if ($(this).val() && $(this).val() !== current && selectedTypes.has($(this).val())) {
                    $(this).hide();
                } else {
                    $(this).show();
                }
            });
        });
    }

    const addBtn = document.getElementById("add-row"),
          tbody = document.getElementById("fee-body"),
          total = document.getElementById("id_fee_details-TOTAL_FORMS");

    addBtn.onclick = () => {
        let count = parseInt(total.value);
        let first = tbody.querySelector(".fee-row");

        if (!first) return;

        let clone = first.cloneNode(true);
        let html = clone.innerHTML.replace(/fee_details-0/g, `fee_details-${count}`);
        clone.innerHTML = html;

        $(clone).find('input, select').each(function () {
            if (this.tagName === 'SELECT') {
                this.selectedIndex = 0;
            } else {
                this.value = '';
            }
        });

        tbody.appendChild(clone);
        total.value = count + 1;

        updateAvailableFeeTypes();
    };

    document.addEventListener("click", e => {
        if (e.target.classList.contains("remove-row")) {
            e.target.closest("tr").remove();
            total.value = document.querySelectorAll(".fee-row").length;
            updateAvailableFeeTypes();
        }
    });

    $(document).ready(function () {
        updateAvailableFeeTypes();

        $('#course-select').change(function () {
            const courseId = $(this).val();
            if (!courseId) {
                $('#semester-select').html('<option value="">Select Sem/Year</option>');
                return;
            }

            $.ajax({
                type: "POST",
                url: "{% url 'get_semesters_by_course' %}",
                data: {
                    'course_id': courseId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    const semesterSelect = $('#semester-select');
                    semesterSelect.empty();
                    semesterSelect.append('<option value="">Select Sem/Year</option>');
                    $.each(response.semesters, function (i, sem) {
                        semesterSelect.append(`<option value="${sem.number}">${sem.name}</option>`);
                    });
                },
                error: function () {
                    alert('Error fetching semester data');
                }
            });
        });

        $('form').on('change', 'select[name$="fee_type"]', function () {
            updateAvailableFeeTypes();
        });
    });
</script>
{% endblock %}
